@using System;
@using System.Collections.Generic;
@using System.Linq;
@using Sandbox;
@using Sandbox.UI;

@namespace Home

<root class="shop-placeable">
    <label class="name" text=@Name />
    <div class="shop-container">
        @if(Target == null)
        {
            <div class="preview" />
        }
        else
        {
            <RotatingModelScenePanel IdleSpeed=@(20) Model=@Target.GetModel() class="preview" />
        }
        <div class="shop">
            <div class="items">
                @foreach(var item in PlaceableList())
                {
                    <ShopPlaceableButton Placeable=@item />
                }
            </div>
        </div>
    </div>
    <img src="/ui/ui_no.png" class="close" onclick="@Close" />
</root>

@code
{
    public HomePlaceable Target { get; set; } = null;
    public virtual string Name => "Shop";
    public virtual string Music => "go_to_the_picnic";

    private Sound PlayingMusic;
    private float MusicVolume = 0f;

    public virtual List<HomePlaceable> PlaceableList()
    {
        return HomePlaceable.All.ToList();
    }

    public void OpenLocally()
    {
        AddClass("open");

        MusicVolume = 0f;
        PlayingMusic = Sound.FromScreen(To.Single(Game.LocalClient), Music).SetVolume(MusicVolume);
    }

    public void Close()
    {
        RemoveClass("open");
    }

    [GameEvent.Tick.Client]
    public void OnTick()
    {
        if(!PlayingMusic.IsPlaying) return;
        bool isOpen = HasClass("open");
        float lerpTo = isOpen ? 0.5f : 0f;
        MusicVolume = MathX.Lerp(MusicVolume, lerpTo, Time.Delta * 5);
        PlayingMusic.SetVolume(MusicVolume);
        if(!isOpen && MusicVolume < 0.01f)
        {
            PlayingMusic.Stop();
        }
    }

    public void SetTarget(HomePlaceable placeable)
    {
        Target = placeable;
    }

}